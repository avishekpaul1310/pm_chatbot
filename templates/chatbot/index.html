{% extends "base.html" %}

{% block title %}Project Management Chatbot{% endblock %}

{% block extra_css %}
<!-- Include the enhanced CSS styles -->
<style>
/* Enhanced Chat Interface Styles */
:root {
    --primary-color: #4a6fa5;
    --secondary-color: #166088;
    --accent-color: #4fc3a1;
    --light-bg: #f8f9fa;
    --dark-text: #343a40;
    --message-bubble-user: #4a6fa5;
    --message-bubble-bot: #f1f3f5;
    --message-text-user: #ffffff;
    --message-text-bot: #343a40;
    --chat-bg: #ffffff;
    --border-radius-lg: 18px;
    --border-radius-sm: 8px;
    --shadow-soft: 0 5px 15px rgba(0,0,0,0.05);
    --shadow-medium: 0 8px 20px rgba(0,0,0,0.1);
    --transition-smooth: all 0.3s ease;
}

.chat-container {
    height: 550px;
    overflow-y: auto;
    background-color: var(--chat-bg);
    border-radius: var(--border-radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-soft);
    scrollbar-width: thin;
    scrollbar-color: var(--secondary-color) transparent;
}

.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
    background-color: rgba(22, 96, 136, 0.3);
    border-radius: 20px;
}

.message {
    margin-bottom: 18px;
    padding: 12px 18px;
    border-radius: var(--border-radius-lg);
    max-width: 80%;
    word-wrap: break-word;
    position: relative;
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-soft);
    line-height: 1.5;
}

.message:hover {
    box-shadow: var(--shadow-medium);
}

.user-message {
    background-color: var(--message-bubble-user);
    color: var(--message-text-user);
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.bot-message {
    background-color: var(--message-bubble-bot);
    color: var(--message-text-bot);
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-source {
    font-size: 11px;
    font-weight: 500;
    margin-top: 6px;
    text-align: right;
    opacity: 0.8;
}

.bot-message .message-source {
    color: #6c757d;
}

.user-message .message-source {
    color: rgba(255, 255, 255, 0.8);
}

.typing-indicator {
    display: none;
    padding: 10px 15px;
    background-color: rgba(233, 236, 239, 0.7);
    border-radius: var(--border-radius-lg);
    margin-bottom: 15px;
    width: 70px;
    border-bottom-left-radius: 5px;
    box-shadow: var(--shadow-soft);
}

.dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    margin-right: 3px;
    animation: wave 1.3s linear infinite;
}

.dot:nth-child(2) {
    animation-delay: -1.1s;
}

.dot:nth-child(3) {
    animation-delay: -0.9s;
}

@keyframes wave {
    0%, 60%, 100% { transform: initial; }
    30% { transform: translateY(-5px); }
}

.input-area {
    background-color: white;
    border-radius: var(--border-radius-lg);
    padding: 8px;
    box-shadow: var(--shadow-medium);
}

.input-group {
    border-radius: var(--border-radius-lg);
}

#user-input {
    border-top-left-radius: var(--border-radius-lg);
    border-bottom-left-radius: var(--border-radius-lg);
    border: none;
    padding: 15px 20px;
    height: 60px;
    font-size: 16px;
    background-color: transparent;
    transition: var(--transition-smooth);
}

#user-input:focus {
    box-shadow: none;
}

.send-btn {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
    color: white;
    border-top-right-radius: var(--border-radius-lg) !important;
    border-bottom-right-radius: var(--border-radius-lg) !important;
    width: 60px;
    transition: var(--transition-smooth);
}

.send-btn:hover {
    background-color: var(--primary-color);
    transform: scale(1.05);
}

.welcome-message {
    text-align: center;
    margin-bottom: 35px;
}

.welcome-message h2 {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--primary-color);
}

.sheet-selector {
    max-width: 300px;
    margin: 0 auto 25px auto;
}

.sheet-selector select {
    border-radius: var(--border-radius-sm);
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: var(--shadow-soft);
    transition: var(--transition-smooth);
}

.sheet-selector select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(79, 195, 161, 0.25);
}

.sheet-badge {
    font-size: 11px;
    vertical-align: top;
    margin-left: 5px;
    background-color: rgba(22, 96, 136, 0.8);
    padding: 3px 8px;
    border-radius: 30px;
}

/* Adding code block styling for better code display in messages */
.bot-message pre {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #333;
}

.bot-message code {
    font-family: 'Courier New', monospace;
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 90%;
    color: #d63384;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message {
        max-width: 90%;
    }
    
    .chat-container {
        height: 450px;
        padding: 15px;
    }
}

/* Animations */
.message {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Improve welcome message appearance */
.app-title {
    color: var(--primary-color);
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="welcome-message">
            <h2 class="app-title">Project Management Assistant</h2>
            <p class="text-muted">Ask me anything about your projects, team members, or budget information!</p>
            
            {% if sheet_names|length > 1 %}
            <div class="sheet-selector">
                <select class="form-select" id="sheet-selector">
                    <option value="">All Project Sheets</option>
                    {% for name in sheet_names %}
                        <option value="{{ name }}">{{ name|title }}</option>
                    {% endfor %}
                </select>
                <div class="form-text text-center">Select a specific sheet or query across all sheets</div>
            </div>
            {% endif %}
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="bot-message message">
                <div>Hello! I'm your project management assistant. 
                {% if sheet_names|length > 1 %}
                I can answer questions about any of your project sheets. Use the dropdown above to focus on a specific sheet.
                {% else %}
                How can I help you today?
                {% endif %}
                </div>
                <div class="message-source">
                    <i class="fas fa-robot me-1"></i> OpenAI GPT-4o-mini
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" class="form-control" id="user-input" placeholder="Type your message here..." aria-label="User message">
                <button class="btn send-btn" type="button" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <p class="text-center text-muted small mt-3">
            <i class="fas fa-info-circle me-1"></i> 
            This chatbot uses OpenAI GPT-4o-mini with Google Gemini as a fallback
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        const chatContainer = $('#chat-container');
        const userInput = $('#user-input');
        const sendBtn = $('#send-btn');
        const typingIndicator = $('#typing-indicator');
        const sheetSelector = $('#sheet-selector');
        let chatHistory = [];

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to enhance message formatting
        function formatMessage(content) {
            // Simple Markdown-like formatting for code
            // Convert code blocks (```code```)
            if (content.includes('```')) {
                content = content.replace(/```(?:(\w+)\n)?([\s\S]*?)```/g, function(match, language, code) {
                    return `<pre><code>${code.trim()}</code></pre>`;
                });
            }
            
            // Convert inline code (`code`)
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks to <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Function to add a new message to the chat
        function addMessage(content, sender, source = null, sheetName = null, dashboardUrl = null) {
            const messageClass = sender === 'user' ? 'user-message' : 'bot-message';
            
            // Format the message content for the bot
            const formattedContent = sender === 'user' ? content : formatMessage(content);
            
            let messageHTML = `<div class="${messageClass} message">`;
            messageHTML += `<div>${formattedContent}</div>`;

            if (sender !== 'user') {
                let sourceInfo = '';
                if (source) {
                    if (source === 'openai') {
                        sourceInfo += '<i class="fas fa-robot me-1"></i> OpenAI GPT-4o-mini';
                    } else if (source === 'gemini') {
                        sourceInfo += '<i class="fas fa-robot me-1"></i> Google Gemini';
                    } else {
                        sourceInfo += source;
                    }
                }
                if (sheetName) {
                    sourceInfo += ` <span class="badge bg-secondary sheet-badge">Sheet: ${sheetName}</span>`;
                }
                if (sourceInfo) {
                    messageHTML += `<div class="message-source">${sourceInfo}</div>`;
                }
                
                // Add dashboard button if available
                if (dashboardUrl) {
                    messageHTML += `
                        <div class="mt-3">
                            <a href="${dashboardUrl}" class="btn btn-primary btn-sm">
                                <i class="fas fa-tachometer-alt me-1"></i>View Dashboard
                            </a>
                        </div>
                    `;
                }
            }

            messageHTML += `</div>`;

            // Add message before typing indicator
            typingIndicator.before(messageHTML);

            // Scroll to bottom
            chatContainer.scrollTop(chatContainer.prop('scrollHeight'));

            // Add to chat history
            chatHistory.push({
                role: sender === 'user' ? 'user' : 'assistant',
                content: content
            });

            // Keep history at a reasonable size (last 20 messages)
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(chatHistory.length - 20);
            }
        }

        // Function to send message to backend
        function sendMessage() {
            const message = userInput.val().trim();
            if (message === '') return;

            // Get selected sheet if any
            const selectedSheet = sheetSelector.val();

            // Add user message to chat
            addMessage(message, 'user');

            // Clear input
            userInput.val('');

            // Show typing indicator
            typingIndicator.show();

            $.ajax({
                type: 'POST',
                url: '/chat/',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message,
                    history: chatHistory,
                    sheet_name: selectedSheet
                }),
                beforeSend: function (xhr) {
                    // Add the CSRF token to the request header
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function (data) {
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Add bot response to chat
                    addMessage(
                        data.response, 
                        'bot', 
                        data.source, 
                        data.sheet_name, 
                        data.dashboard_url
                    );
                },
                error: function (xhr, status, error) {
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Show error message
                    let errorMessage = "Sorry, I encountered an error processing your request.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += " Details: " + xhr.responseJSON.error;
                    }
                    addMessage(errorMessage, 'bot', 'Error');

                    console.error("AJAX Error:", status, error);
                }
            });
        }

        // Send button click handler
        sendBtn.on('click', sendMessage);

        // Send message on Enter key
        userInput.on('keypress', function (e) {
            if (e.which === 13) {
                sendMessage();
            }
        });

        // Sheet selector change handler - optionally add a message about changing context
        sheetSelector.on('change', function () {
            const selectedSheet = $(this).val();
            const message = selectedSheet
                ? `Now focusing on the "${selectedSheet}" project sheet.`
                : "Now considering all project sheets.";

            addMessage(message, 'bot', 'System');
        });

        // Focus input on page load
        userInput.focus();
    });
</script>
{% endblock %}