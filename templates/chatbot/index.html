{% extends "base.html" %}

{% block title %}Project Management Chatbot{% endblock %}

{% block extra_css %}
<!-- Include the enhanced CSS styles -->
<style>
/* Enhanced Chat Interface Styles */
:root {
    --primary-color: #4a6fa5;
    --secondary-color: #166088;
    --accent-color: #4fc3a1;
    --light-bg: #f8f9fa;
    --dark-text: #343a40;
    --message-bubble-user: #4a6fa5;
    --message-bubble-bot: #f1f3f5;
    --message-text-user: #ffffff;
    --message-text-bot: #343a40;
    --chat-bg: #ffffff;
    --border-radius-lg: 18px;
    --border-radius-sm: 8px;
    --shadow-soft: 0 5px 15px rgba(0,0,0,0.05);
    --shadow-medium: 0 8px 20px rgba(0,0,0,0.1);
    --transition-smooth: all 0.3s ease;
}

.chat-container {
    height: 550px;
    overflow-y: auto;
    background-color: var(--chat-bg);
    border-radius: var(--border-radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-soft);
    scrollbar-width: thin;
    scrollbar-color: var(--secondary-color) transparent;
}

.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
    background-color: rgba(22, 96, 136, 0.3);
    border-radius: 20px;
}

.message {
    margin-bottom: 18px;
    padding: 12px 18px;
    border-radius: var(--border-radius-lg);
    max-width: 80%;
    word-wrap: break-word;
    position: relative;
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-soft);
    line-height: 1.5;
}

.message:hover {
    box-shadow: var(--shadow-medium);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    font-size: 0.8rem;
    opacity: 0.7;
}

.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 5px;
}

.message-action-btn {
    background: none;
    border: none;
    color: inherit;
    opacity: 0.6;
    cursor: pointer;
    padding: 2px;
    transition: all 0.2s ease;
}

.message-action-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}

.user-message {
    background-color: var(--message-bubble-user);
    color: var(--message-text-user);
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.bot-message {
    background-color: var(--message-bubble-bot);
    color: var(--message-text-bot);
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-timestamp {
    font-size: 0.75rem;
    opacity: 0.8;
}

.message-source {
    font-size: 11px;
    font-weight: 500;
    margin-top: 6px;
    text-align: right;
    opacity: 0.8;
}

.bot-message .message-source {
    color: #6c757d;
}

.user-message .message-source {
    color: rgba(255, 255, 255, 0.8);
}

/* Star feature */
.starred {
    position: relative;
}

.starred::before {
    content: 'â˜…';
    position: absolute;
    top: -10px;
    right: -10px;
    font-size: 1.5rem;
    color: #ffc107;
    z-index: 1;
    text-shadow: 0 0 3px rgba(0,0,0,0.3);
    animation: star-pulse 1s ease;
}

@keyframes star-pulse {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* Improved typing indicator */
.typing-indicator {
    display: none;
    padding: 15px;
    background-color: var(--message-bubble-bot);
    border-radius: var(--border-radius-lg);
    margin-bottom: 15px;
    width: auto;
    max-width: 100px;
    border-bottom-left-radius: 5px;
    box-shadow: var(--shadow-soft);
    position: relative;
}

.typing-indicator .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    margin-right: 4px;
    animation: typing-dot 1.3s infinite ease-in-out;
}

.typing-indicator .dot:nth-child(1) {
    animation-delay: 0s;
}

.typing-indicator .dot:nth-child(2) {
    animation-delay: 0.15s;
}

.typing-indicator .dot:nth-child(3) {
    animation-delay: 0.3s;
    margin-right: 0;
}

@keyframes typing-dot {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-8px); }
}

/* Export chat button */
.export-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--message-bubble-bot);
    color: var(--dark-text);
    border: none;
    box-shadow: var(--shadow-medium);
    transition: all 0.2s ease;
}

.export-btn:hover {
    transform: scale(1.1);
    background-color: var(--accent-color);
    color: white;
}

.chat-container-wrapper {
    position: relative;
}

/* Adding code block styling for better code display in messages */
.bot-message pre {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #333;
}

.bot-message code {
    font-family: 'Courier New', monospace;
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 90%;
    color: #d63384;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message {
        max-width: 90%;
    }
    
    .chat-container {
        height: 450px;
        padding: 15px;
    }
}

/* Animations */
.message {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Improve welcome message appearance */
.app-title {
    color: var(--primary-color);
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="welcome-message">
            <h2 class="app-title">Project Management Assistant</h2>
            <p class="text-muted">Ask me anything about your projects, team members, or budget information!</p>
            
            {% if sheet_names|length > 1 %}
            <div class="sheet-selector">
                <select class="form-select" id="sheet-selector">
                    <option value="">All Project Sheets</option>
                    {% for name in sheet_names %}
                        <option value="{{ name }}">{{ name|title }}</option>
                    {% endfor %}
                </select>
                <div class="form-text text-center">Select a specific sheet or query across all sheets</div>
            </div>
            {% endif %}
            
            <!-- Add View Starred button -->
            <div class="text-end mt-3">
                <button id="view-starred" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-star me-1"></i>View Starred
                </button>
            </div>
        </div>
        
        <div class="chat-container-wrapper">
            <button class="export-btn" id="export-chat" title="Export Conversation">
                <i class="fas fa-download"></i>
            </button>
            <div class="chat-container" id="chat-container">
                <div class="bot-message message">
                    <div class="message-header">
                        <span>Assistant</span>
                        <span class="message-timestamp">Just now</span>
                    </div>
                    <div>Hello! I'm your project management assistant. 
                    {% if sheet_names|length > 1 %}
                    I can answer questions about any of your project sheets. Use the dropdown above to focus on a specific sheet.
                    {% else %}
                    How can I help you today?
                    {% endif %}
                    </div>
                    <div class="message-source">
                        <i class="fas fa-robot me-1"></i> OpenAI GPT-4o-mini
                    </div>
                    <div class="message-actions">
                        <button class="message-action-btn" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="message-action-btn star-btn" title="Star this message">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" class="form-control" id="user-input" placeholder="Type your message here..." aria-label="User message">
                <button class="btn send-btn" type="button" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <p class="text-center text-muted small mt-3">
            <i class="fas fa-info-circle me-1"></i> 
            This chatbot uses OpenAI GPT-4o-mini
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        const chatContainer = $('#chat-container');
        const userInput = $('#user-input');
        const sendBtn = $('#send-btn');
        const typingIndicator = $('#typing-indicator');
        const sheetSelector = $('#sheet-selector');
        const exportBtn = $('#export-chat');
        const viewStarredBtn = $('#view-starred');
        let chatHistory = [];

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to get current timestamp
        function getCurrentTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Function to enhance message formatting
        function formatMessage(content) {
            // Simple Markdown-like formatting for code
            // Convert code blocks (```code```)
            if (content.includes('```')) {
                content = content.replace(/```(?:(\w+)\n)?([\s\S]*?)```/g, function(match, language, code) {
                    return `<pre><code>${code.trim()}</code></pre>`;
                });
            }
            
            // Convert inline code (`code`)
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks to <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Function to add a new message to the chat
        function addMessage(content, sender, source = null, sheetName = null, dashboardUrl = null) {
            const messageClass = sender === 'user' ? 'user-message' : 'bot-message';
            const senderName = sender === 'user' ? 'You' : 'Assistant';
            const timestamp = getCurrentTimestamp();
            
            // Format the message content for the bot
            const formattedContent = sender === 'user' ? content : formatMessage(content);
            
            let messageHTML = `<div class="${messageClass} message">`;
            messageHTML += `<div class="message-header">
                                <span>${senderName}</span>
                                <span class="message-timestamp">${timestamp}</span>
                            </div>`;
            messageHTML += `<div>${formattedContent}</div>`;

            if (sender !== 'user') {
                let sourceInfo = '';
                if (source) {
                    if (source === 'openai') {
                        sourceInfo += '<i class="fas fa-robot me-1"></i> OpenAI GPT-4o-mini';
                    } else {
                        sourceInfo += source;
                    }
                }
                if (sheetName) {
                    sourceInfo += ` <span class="badge bg-secondary sheet-badge">Sheet: ${sheetName}</span>`;
                }
                if (sourceInfo) {
                    messageHTML += `<div class="message-source">${sourceInfo}</div>`;
                }
                
                // Add dashboard button if available
                if (dashboardUrl) {
                    messageHTML += `
                        <div class="mt-3">
                            <a href="${dashboardUrl}" class="btn btn-primary btn-sm">
                                <i class="fas fa-tachometer-alt me-1"></i>View Dashboard
                            </a>
                        </div>
                    `;
                }

                // Add message actions for bot messages
                messageHTML += `
                    <div class="message-actions">
                        <button class="message-action-btn copy-btn" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="message-action-btn star-btn" title="Star this message">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                `;
            }

            messageHTML += `</div>`;

            // Add message before typing indicator
            typingIndicator.before(messageHTML);

            // Scroll to bottom
            chatContainer.scrollTop(chatContainer.prop('scrollHeight'));

            // Add to chat history
            chatHistory.push({
                role: sender === 'user' ? 'user' : 'assistant',
                content: content
            });

            // Keep history at a reasonable size (last 20 messages)
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(chatHistory.length - 20);
            }
        }

        // Function to send message to backend
        function sendMessage() {
            const message = userInput.val().trim();
            if (message === '') return;

            // Get selected sheet if any
            const selectedSheet = sheetSelector.val();

            // Add user message to chat
            addMessage(message, 'user');

            // Clear input
            userInput.val('');

            // Show typing indicator
            typingIndicator.show();

            $.ajax({
                type: 'POST',
                url: '/chat/',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message,
                    history: chatHistory,
                    sheet_name: selectedSheet
                }),
                beforeSend: function (xhr) {
                    // Add the CSRF token to the request header
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function (data) {
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Add bot response to chat
                    addMessage(
                        data.response, 
                        'bot', 
                        data.source, 
                        data.sheet_name, 
                        data.dashboard_url
                    );
                },
                error: function (xhr, status, error) {
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Show error message
                    let errorMessage = "Sorry, I encountered an error processing your request.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += " Details: " + xhr.responseJSON.error;
                    }
                    addMessage(errorMessage, 'bot', 'Error');

                    console.error("AJAX Error:", status, error);
                }
            });
        }

        // Send button click handler
        sendBtn.on('click', sendMessage);

        // Send message on Enter key
        userInput.on('keypress', function (e) {
            if (e.which === 13) {
                sendMessage();
            }
        });

        // Sheet selector change handler - optionally add a message about changing context
        sheetSelector.on('change', function () {
            const selectedSheet = $(this).val();
            const message = selectedSheet
                ? `Now focusing on the "${selectedSheet}" project sheet.`
                : "Now considering all project sheets.";

            addMessage(message, 'bot', 'System');
        });

        // Handle message actions
        $(document).on('click', '.star-btn', function() {
            const messageEl = $(this).closest('.message');
            const messageContent = messageEl.find('div:nth-child(2)').text().trim();
            const timestamp = messageEl.find('.message-timestamp').text();
            const starredMessages = JSON.parse(localStorage.getItem('starredMessages')) || [];

            if (messageEl.hasClass('starred')) {
                messageEl.removeClass('starred');
                $(this).html('<i class="far fa-star"></i>');

                // Remove from localStorage
                const updatedMessages = starredMessages.filter(msg => msg.content !== messageContent || msg.timestamp !== timestamp);
                localStorage.setItem('starredMessages', JSON.stringify(updatedMessages));
            } else {
                messageEl.addClass('starred');
                $(this).html('<i class="fas fa-star"></i>');

                // Add to localStorage
                starredMessages.push({ content: messageContent, timestamp: timestamp });
                localStorage.setItem('starredMessages', JSON.stringify(starredMessages));
            }
        });

        $(document).on('click', '.copy-btn', function() {
            const messageEl = $(this).closest('.message');
            const textToCopy = messageEl.find('div:nth-child(2)').text().trim();
            
            navigator.clipboard.writeText(textToCopy).then(function() {
                // Show temporary feedback
                const originalIcon = $(this).html();
                $(this).html('<i class="fas fa-check"></i>');
                setTimeout(() => {
                    $(this).html(originalIcon);
                }, 1500);
            }.bind(this), function() {
                console.error('Failed to copy text');
            });
        });

        // Export chat functionality
        exportBtn.on('click', function() {
            const conversationText = [];
            
            $('.message').each(function() {
                const isBot = $(this).hasClass('bot-message');
                const sender = isBot ? "Assistant" : "You";
                const timestamp = $(this).find('.message-timestamp').text();
                const content = $(this).find('div:nth-child(2)').text().trim();
                
                conversationText.push(`[${timestamp}] ${sender}: ${content}`);
            });
            
            const exportText = conversationText.join('\n\n');
            const blob = new Blob([exportText], {type: "text/plain;charset=utf-8"});
            
            // Create a link element to download the file
            const a = document.createElement("a");
            const date = new Date().toISOString().slice(0,10);
            a.href = URL.createObjectURL(blob);
            a.download = `chat_export_${date}.txt`;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // View starred messages functionality
        viewStarredBtn.on('click', function() {
            const starredMessages = JSON.parse(localStorage.getItem('pmChatbot_starredMessages') || '[]');
            
            const modalHTML = `
            <div class="modal fade" id="starredMessagesModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-star me-2"></i>Starred Messages</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="starred-messages-container">
                                ${starredMessages.map(message => `
                                    <div class="starred-message p-3 mb-3 rounded ${message.isUser ? 'bg-primary text-white' : 'bg-light'}">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-bold">${message.isUser ? 'You' : 'Assistant'}</span>
                                            <small class="text-opacity-75">${message.timestamp}</small>
                                        </div>
                                        <div class="message-content">${message.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ${starredMessages.length === 0 ? '<p class="text-center py-4">No starred messages found.</p>' : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-danger" id="clear-starred">Clear All Starred</button>
                        </div>
                    </div>
                </div>
            </div>
            `;

            $('body').append(modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('starredMessagesModal'));
            modal.show();

            // Add "Clear All Starred" functionality
            $('#clear-starred').on('click', function() {
                if (confirm('Are you sure you want to clear all starred messages?')) {
                    // Clear the localStorage
                    localStorage.removeItem('pmChatbot_starredMessages');
                    
                    // Remove starred classes from all messages
                    $('.message.starred').removeClass('starred');
                    $('.star-btn').html('<i class="far fa-star"></i>');
                    
                    // Close the modal
                    bootstrap.Modal.getInstance(document.getElementById('starredMessagesModal')).hide();
                }
            });

            $('#starredMessagesModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        });
        
        // Focus input on page load
        userInput.focus();
    });
</script>
{% endblock %}